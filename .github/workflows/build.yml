name: Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Checkout quiet library
        run: git clone --recursive https://github.com/hebo6/org.quietmodem.Quiet.git ../org.quietmodem.Quiet

      - name: Checkout native sources
        run: |
          git clone https://github.com/quiet/libcorrect.git /tmp/libcorrect
          git clone https://github.com/akheron/jansson.git /tmp/jansson
          git clone --branch devel https://github.com/quiet/liquid-dsp.git /tmp/liquid-dsp
          git clone https://github.com/hebo6/quiet.git /tmp/quiet
          git clone https://github.com/hebo6/quiet-lwip.git /tmp/quiet-lwip

      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y cmake build-essential

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components
        run: sdkmanager "platforms;android-23" "build-tools;26.0.2" "build-tools;34.0.0"

      - name: Install NDK
        run: |
          sdkmanager "ndk;21.4.7075529"
          echo "ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/21.4.7075529" >> $GITHUB_ENV

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '8'

      - name: Patch source trees for cross-compilation
        run: |
          # liquid-dsp: fix autoscript target expression for cross-compile
          sed -i 's|\$<TARGET_FILE:autoscript>|${CMAKE_CURRENT_BINARY_DIR}/autoscript|g' /tmp/liquid-dsp/CMakeLists.txt
          # liquid-dsp: skip complex math checks (Android API 21 has them in libcomplex, not libm)
          # We pre-set the cache vars so CHECK_REQUIRED_FUNCTION skips the try_compile
          sed -i '/CHECK_REQUIRED_FUNCTION(cargf/d' /tmp/liquid-dsp/CMakeLists.txt
          sed -i '/CHECK_REQUIRED_FUNCTION(cexpf/d' /tmp/liquid-dsp/CMakeLists.txt
          sed -i '/CHECK_REQUIRED_FUNCTION(crealf/d' /tmp/liquid-dsp/CMakeLists.txt
          sed -i '/CHECK_REQUIRED_FUNCTION(cimagf/d' /tmp/liquid-dsp/CMakeLists.txt
          # quiet-lwip: build SHARED instead of STATIC
          sed -i 's/add_library(quiet_lwip STATIC/add_library(quiet_lwip SHARED/' /tmp/quiet-lwip/CMakeLists.txt
          # quiet-lwip: remove all CMAKE_C_FLAGS/CMAKE_EXE_LINKER_FLAGS overrides
          # (unquoted ${CMAKE_C_FLAGS} breaks NDK toolchain cross-compilation)
          sed -i '/set(CMAKE_C_FLAGS/d' /tmp/quiet-lwip/CMakeLists.txt
          sed -i '/set(CMAKE_EXE_LINKER_FLAGS/d' /tmp/quiet-lwip/CMakeLists.txt
          # quiet-lwip: remove pthread (Android bionic includes it in libc)
          sed -i 's/set(CORE_DEPENDENCIES quiet pthread)/set(CORE_DEPENDENCIES quiet)/' /tmp/quiet-lwip/CMakeLists.txt
          # quiet-lwip: add -llog for __android_log_print debug logging
          sed -i 's/target_link_libraries(quiet_lwip ${CORE_DEPENDENCIES})/target_link_libraries(quiet_lwip ${CORE_DEPENDENCIES} log)/' /tmp/quiet-lwip/CMakeLists.txt
          # JNI Android.mk: add SOCKLEN_T_DEFINED to avoid socklen_t redefinition
          sed -i 's/LOCAL_CFLAGS := /LOCAL_CFLAGS := -DSOCKLEN_T_DEFINED -DLWIP_DNS=1 -DLWIP_AUTOIP=1 /' ../org.quietmodem.Quiet/quiet/src/main/jni/Android.mk
          # JNI Application.mk: set APP_STL to none (pure C code, no C++ runtime needed)
          # libstdc++.so dependency causes linker namespace conflict that unloads GPU driver
          echo 'APP_STL := none' >> ../org.quietmodem.Quiet/quiet/src/main/jni/Application.mk
          # quiet-lwip: add missing functions expected by JNI code
          # 1. Rename existing static quiet_lwip_init to quiet_lwip_netif_init (avoid name conflict)
          sed -i 's/static err_t quiet_lwip_init/static err_t quiet_lwip_netif_init/' /tmp/quiet-lwip/src/driver.c
          sed -i 's/conf, quiet_lwip_init,/conf, quiet_lwip_netif_init,/' /tmp/quiet-lwip/src/driver.c
          # 1b. Add debug logging to quiet_lwip_netif_init (encoder/decoder creation)
          sed -i '1i #include <android/log.h>\n#define QLOG(...) __android_log_print(ANDROID_LOG_DEBUG, "quiet-native", __VA_ARGS__)' /tmp/quiet-lwip/src/driver.c
          sed -i '/static err_t quiet_lwip_netif_init(struct netif \*netif) {/a\    QLOG("quiet_lwip_netif_init: enter");' /tmp/quiet-lwip/src/driver.c
          sed -i '/quiet_encoder *e = quiet_encoder_create/i\    QLOG("quiet_lwip_netif_init: creating encoder");' /tmp/quiet-lwip/src/driver.c
          sed -i '/quiet_decoder *d = quiet_decoder_create/i\    QLOG("quiet_lwip_netif_init: encoder created=%p, creating decoder", (void*)e);' /tmp/quiet-lwip/src/driver.c
          sed -i '/netif->state = driver;/i\    QLOG("quiet_lwip_netif_init: decoder created=%p", (void*)d);' /tmp/quiet-lwip/src/driver.c
          sed -i '/return ERR_OK;/i\    QLOG("quiet_lwip_netif_init: done");' /tmp/quiet-lwip/src/driver.c
          # 1c. Add debug logging to quiet_lwip_create
          sed -i '/quiet_lwip_interface \*quiet_lwip_create/,/^}/ {
            /quiet_lwip_interface \*interface = malloc/a\    QLOG("quiet_lwip_create: allocated interface=%p", (void*)interface);
            /netif_add(interface/i\    QLOG("quiet_lwip_create: calling netif_add");
            /netif_set_up(interface)/i\    QLOG("quiet_lwip_create: netif_add done, calling netif_set_up");
            /return interface;/i\    QLOG("quiet_lwip_create: done");
          }' /tmp/quiet-lwip/src/driver.c
          # 2. Append new functions at end of driver.c
          cat >> /tmp/quiet-lwip/src/driver.c << 'PATCH'

          #include "lwip/autoip.h"
          #include <stdbool.h>
          static bool _quiet_lwip_initialized = false;
          void quiet_lwip_init() {
              QLOG("quiet_lwip_init: enter");
              if (!_quiet_lwip_initialized) {
                  QLOG("quiet_lwip_init: calling tcpip_init");
                  tcpip_init(NULL, NULL);
                  _quiet_lwip_initialized = true;
                  QLOG("quiet_lwip_init: tcpip_init done");
              }
              QLOG("quiet_lwip_init: exit");
          }
          void quiet_lwip_close(quiet_lwip_interface *interface) {
              netif_set_down(interface);
              netif_remove(interface);
          }
          quiet_lwip_interface *quiet_lwip_autoip(quiet_lwip_interface *interface) {
              autoip_start(interface);
              return interface;
          }
          void quiet_lwip_start_threads(quiet_lwip_interface *interface) {
              (void)interface;
          }
          PATCH
          # 3. Remove the inline tcpip_init in quiet_lwip_create (quiet_lwip_init handles it now)
          sed -i '/static bool has_lwip_init/d' /tmp/quiet-lwip/src/driver.c
          sed -i '/if (!has_lwip_init)/,/}/d' /tmp/quiet-lwip/src/driver.c
          # 4. Add debug logging to JNI network_interface.c (lwip_android_create)
          JNI_NI=../org.quietmodem.Quiet/quiet/src/main/jni/network_interface.c
          sed -i '1i #include <android/log.h>\n#define NILOG(...) __android_log_print(ANDROID_LOG_DEBUG, "quiet-jni", __VA_ARGS__)' "$JNI_NI"
          sed -i '/quiet_lwip_android \*e = malloc/a\    NILOG("lwip_android_create: enter, is_loopback=%d", is_loopback);' "$JNI_NI"
          sed -i '/e->interface = quiet_lwip_create/a\    NILOG("lwip_android_create: quiet_lwip_create returned %p", (void*)e->interface);' "$JNI_NI"
          sed -i '/e->producer = opensl_producer_create/i\    NILOG("lwip_android_create: creating opensl producer");' "$JNI_NI"
          sed -i '/e->consumer = opensl_consumer_create/i\    NILOG("lwip_android_create: creating opensl consumer");' "$JNI_NI"
          sed -i '/SLresult res = quiet_opensl_create_player/i\        NILOG("lwip_android_create: creating opensl player");' "$JNI_NI"
          sed -i '/res = quiet_opensl_create_recorder/i\        NILOG("lwip_android_create: player created, creating opensl recorder");' "$JNI_NI"
          sed -i '/return e;$/i\    NILOG("lwip_android_create: all done, returning");' "$JNI_NI"
          # 5. Add debug logging to nativeOpen
          sed -i '/l = lwip_android_create/i\    NILOG("nativeOpen: calling lwip_android_create");' "$JNI_NI"
          sed -i '/return jvm_opaque_pointer(l);/i\    NILOG("nativeOpen: lwip_android_create returned %p", (void*)l);' "$JNI_NI"
          # 6. Add debug logging to quiet encoder/decoder creation
          QUIET_ENC=/tmp/quiet/src/encoder.c
          sed -i '1i #include <android/log.h>\n#define ELOG(...) __android_log_print(ANDROID_LOG_DEBUG, "quiet-enc", __VA_ARGS__)' "$QUIET_ENC"
          sed -i '/encoder \*quiet_encoder_create/,/^}/ {
            /encoder \*e = malloc/a\    ELOG("quiet_encoder_create: encoding=%d sample_rate=%f", opt->encoding, sample_rate);
            /encoder_ofdm_create/i\        ELOG("quiet_encoder_create: ofdm path");
            /encoder_modem_create/i\        ELOG("quiet_encoder_create: modem path");
            /encoder_gmsk_create/i\        ELOG("quiet_encoder_create: gmsk path");
            /e->mod = modulator_create/i\    ELOG("quiet_encoder_create: frame created, creating modulator");
            /e->resampler = resamp_rrrf_create/i\        ELOG("quiet_encoder_create: creating resampler rate=%f", rate);
            /e->buf = ring_create/i\    ELOG("quiet_encoder_create: modulator done, creating ring buffer");
            /return e;$/i\    ELOG("quiet_encoder_create: done");
          }' "$QUIET_ENC"
          # Also add -llog to quiet library
          sed -i 's/set(CORE_DEPENDENCIES liquid jansson m)/set(CORE_DEPENDENCIES liquid jansson m log)/' /tmp/quiet/CMakeLists.txt
          # 7. Add audio input level monitoring to opensl.c record_callback
          OPENSL=../org.quietmodem.Quiet/quiet/src/main/jni/opensl.c
          sed -i '1i #include <android/log.h>\n#include <math.h>\n#define ALOG(...) __android_log_print(ANDROID_LOG_DEBUG, "quiet-audio", __VA_ARGS__)' "$OPENSL"
          sed -i '/void record_callback/,/^}/ {
            /c->consume(c->consume_arg/a\    { static int _cb_count = 0; _cb_count++; if (_cb_count % 100 == 1) { float _max = 0.0f, _sum = 0.0f; for (size_t _i = 0; _i < c->num_frames; _i++) { float _a = fabsf(c->scratch[_i]); if (_a > _max) _max = _a; _sum += _a; } ALOG("record_cb #%d: frames=%zu max=%.4f avg=%.6f", _cb_count, c->num_frames, _max, _sum / c->num_frames); } }
          }' "$OPENSL"

      - name: Cross-compile native libraries
        run: |
          set -e
          NDK=$ANDROID_HOME/ndk/21.4.7075529
          TOOLCHAIN=$NDK/build/cmake/android.toolchain.cmake
          JNI_BASE=$(cd ../org.quietmodem.Quiet/quiet/src/main/jni && pwd)
          ABIS="armeabi-v7a arm64-v8a x86 x86_64"

          for ABI in $ABIS; do
            echo "========== Building for $ABI =========="
            PREFIX=/tmp/install/$ABI
            mkdir -p $PREFIX

            CMAKE_COMMON="-DCMAKE_TOOLCHAIN_FILE=$TOOLCHAIN \
              -DANDROID_ABI=$ABI \
              -DANDROID_PLATFORM=android-21 \
              -DCMAKE_INSTALL_PREFIX=$PREFIX \
              -DCMAKE_FIND_ROOT_PATH=$PREFIX \
              -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=BOTH \
              -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=BOTH"

            # 1. libcorrect -> libcorrect.so + libfec.so
            rm -rf /tmp/build-correct-$ABI && mkdir /tmp/build-correct-$ABI
            cmake -S /tmp/libcorrect -B /tmp/build-correct-$ABI $CMAKE_COMMON -DCMAKE_C_FLAGS="-fPIC"
            make -C /tmp/build-correct-$ABI -j$(nproc)
            make -C /tmp/build-correct-$ABI shim
            make -C /tmp/build-correct-$ABI install

            # 2. jansson -> libjansson.so
            rm -rf /tmp/build-jansson-$ABI && mkdir /tmp/build-jansson-$ABI
            cmake -S /tmp/jansson -B /tmp/build-jansson-$ABI $CMAKE_COMMON -DJANSSON_BUILD_DOCS=OFF -DJANSSON_EXAMPLES=OFF -DJANSSON_BUILD_SHARED_LIBS=ON
            make -C /tmp/build-jansson-$ABI -j$(nproc)
            make -C /tmp/build-jansson-$ABI install

            # Pre-install libcomplex (provides cargf etc. missing from Android API 21)
            mkdir -p $PREFIX/lib $PREFIX/include
            cp $JNI_BASE/lib/$ABI/libcomplex.so $PREFIX/lib/
            cp $JNI_BASE/include/$ABI/complex.h $PREFIX/include/

            # 3. liquid-dsp -> libliquid.so
            rm -rf /tmp/build-liquid-$ABI && mkdir /tmp/build-liquid-$ABI
            LIQUID_EXTRA=""
            case $ABI in
              arm64-v8a) LIQUID_EXTRA="-DLIQUID_FORCE_ARM64_NEON=ON" ;;
              armeabi-v7a) LIQUID_EXTRA="-DLIQUID_FORCE_ARM_NEON=ON" ;;
              *) LIQUID_EXTRA="-DLIQUID_SIMDOVERRIDE=ON" ;;
            esac
            cmake -S /tmp/liquid-dsp -B /tmp/build-liquid-$ABI $CMAKE_COMMON \
              -DHOST_C_COMPILER=gcc \
              -DLIQUID_BUILD_EXAMPLES=OFF \
              -DLIQUID_BUILD_SANDBOX=OFF \
              -DCMAKE_SHARED_LINKER_FLAGS="-L$PREFIX/lib -lcomplex" \
              $LIQUID_EXTRA
            make -C /tmp/build-liquid-$ABI -j$(nproc)
            make -C /tmp/build-liquid-$ABI install

            # 4. quiet -> libquiet.so
            rm -rf /tmp/build-quiet-$ABI && mkdir /tmp/build-quiet-$ABI
            cmake -S /tmp/quiet -B /tmp/build-quiet-$ABI $CMAKE_COMMON \
              -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
              -DCMAKE_C_FLAGS="-D_DEFAULT_SOURCE" \
              -DLIQUID_DEVEL_FUNCTIONS=ON
            make -C /tmp/build-quiet-$ABI -j$(nproc)
            make -C /tmp/build-quiet-$ABI install

            # 5. quiet-lwip -> libquiet_lwip.so
            rm -rf /tmp/build-lwip-$ABI && mkdir /tmp/build-lwip-$ABI
            cmake -S /tmp/quiet-lwip -B /tmp/build-lwip-$ABI $CMAKE_COMMON \
              -DCMAKE_C_FLAGS="-std=c11 -O2 -fPIC -D_DEFAULT_SOURCE -D_XOPEN_SOURCE=700 -DSOCKLEN_T_DEFINED -DLWIP_DNS=1 -DLWIP_AUTOIP=1 -Wpedantic -Wall -I$PREFIX/include" \
              -DCMAKE_SHARED_LINKER_FLAGS="-L$PREFIX/lib"
            make -C /tmp/build-lwip-$ABI -j$(nproc)
            # quiet-lwip has no install target; copy manually
            cp /tmp/build-lwip-$ABI/lib/libquiet_lwip.so $PREFIX/lib/

            # Copy .so files to JNI prebuilt directory
            JNI_LIB=$JNI_BASE/lib/$ABI
            mkdir -p $JNI_LIB
            cp $PREFIX/lib/libliquid.so $JNI_LIB/
            cp $PREFIX/lib/libquiet.so $JNI_LIB/
            cp $PREFIX/lib/libquiet_lwip.so $JNI_LIB/
            cp $PREFIX/lib/libjansson.so $JNI_LIB/
            cp $PREFIX/lib/libcorrect.so $JNI_LIB/
            cp $PREFIX/lib/libfec.so $JNI_LIB/

            # Update headers (keep existing quiet-lwip.h which has extra JNI function declarations)
            INC=$JNI_BASE/include/$ABI
            mkdir -p $INC/liquid
            cp $PREFIX/include/liquid/liquid.h $INC/liquid/
            cp $PREFIX/include/quiet.h $INC/
            cp $PREFIX/include/jansson.h $INC/
            cp $PREFIX/include/jansson_config.h $INC/
            cp $PREFIX/include/fec.h $INC/
            mkdir -p $INC/quiet-lwip
            cp /tmp/quiet-lwip/include/quiet-lwip/lwip-socket.h $INC/quiet-lwip/
            cp -r /tmp/quiet-lwip/include/lwip $INC/quiet-lwip/lwip
          done

      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew :app:assembleRelease -x lint -x lintVitalRelease

      - name: Sign APK
        run: |
          BUILD_TOOLS=$ANDROID_HOME/build-tools/34.0.0
          APK_IN=app/build/outputs/apk/app-release-unsigned.apk
          APK_ALIGNED=/tmp/app-release-aligned.apk
          APK_SIGNED=/tmp/app-release-signed.apk
          KEYSTORE=/tmp/release.jks
          # Decode keystore from secret
          echo "${{ secrets.SIGNING_KEY }}" | base64 -d > $KEYSTORE
          # Align
          $BUILD_TOOLS/zipalign -v -p 4 $APK_IN $APK_ALIGNED
          # Sign
          $BUILD_TOOLS/apksigner sign \
            --ks $KEYSTORE \
            --ks-key-alias ${{ secrets.ALIAS }} \
            --ks-pass pass:${{ secrets.KEY_STORE_PASSWORD }} \
            --key-pass pass:${{ secrets.KEY_PASSWORD }} \
            --out $APK_SIGNED \
            $APK_ALIGNED
          # Verify
          $BUILD_TOOLS/apksigner verify --verbose $APK_SIGNED

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: quiet-android-release-apk
          path: /tmp/app-release-signed.apk
